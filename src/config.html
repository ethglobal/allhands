<!doctype html>
<html>
    <head>
        <base target="_top" />
    </head>

    <body>
        <form id="configForm">
            <div id="configFields"></div>
            <input type="button" value="Save" onclick="saveConfig()" />
        </form>

        <script type="text/javascript">
            async function loadConfig() {
                await google.script.run
                    .withSuccessHandler(renderForm)
                    .getConfig();
            }

            function renderForm({ schema, configSettings }) {
                const config = JSON.parse(configSettings || "{}");

                const form = document.getElementById("configFields");

                schema.forEach((item) => {
                    const label = document.createElement("label");
                    label.setAttribute("for", item.key);
                    label.textContent = item.label + ":";

                    let input;
                    if (item.type === "boolean") {
                        input = document.createElement("input");
                        input.type = "checkbox";
                        input.checked = config[item.key] || false;
                    } else {
                        input = document.createElement("input");
                        input.type = item.type === "string" ? "text" : "number";
                        input.value = config[item.key] || "";
                    }

                    input.id = item.key;
                    input.name = item.key;

                    form.appendChild(label);
                    form.appendChild(input);
                    form.appendChild(document.createElement("br"));
                });
            }

            async function saveConfig() {
                const config = {};
                const formElements =
                    document.getElementById("configForm").elements;

                for (let element of formElements) {
                    if (element.type === "checkbox") {
                        config[element.name] = element.checked;
                    } else if (
                        element.type === "text" ||
                        element.type === "number"
                    ) {
                        config[element.name] =
                            element.type === "number"
                                ? parseFloat(element.value)
                                : element.value;
                    }
                }

                await google.script.run.saveConfig(JSON.stringify(config));
                google.script.host.close();
            }

            loadConfig();
        </script>
    </body>
</html>
